<% title 'Acompanhamento de pedidos FBM' %>

<div class="container">
  <% if @orders['payload']["NextToken"].present? %>
    <%= link_to view_live_orders_dashboard_index_path(order_kind: 'MFN', next_token: @orders['payload']["NextToken"]), class: 'btn btn-primary', target: '_blank' do %><i class="fas fa-plus"></i> Pr√≥ximos 100 pedidos <% end %>
  <% end %>
  <div class="row">
    <div class="col-12">
      <table class="table table-dark table-hover table-responsive table-striped" style="overflow-x: scroll;" id="orders-table">
        <thead>
          <tr>
            <th class="text-center" width=100><i class="fa fa-ellipsis-v"></i></th>
            <th class="text-center"><%= 'Data' %></th>
            <th class="text-center"><%= 'Detalhes' %></th>
            <th class="text-center"><%= 'Imagem' %></th>
            <th class="text-center"><%= 'Nome do Produto(s)' %></th>
            <th class="text-center"><%= 'Status' %></th>
          </tr>
        </thead>
        <tbody>
          <% @orders['payload']['Orders'].each do |order| %>
            <tr>
              <td class="text-center">
                <div class="btn-group" role="group">
                  <% if OrderMarkup.find_by(amazon_order_id: order['AmazonOrderId'], status: 'concluded').present? %>
                    <button class="btn btn-success"><i class="fas fa-check"></i></button>
                    <button class="btn btn-light change-order-status" data-order-status='<%= 'pending' %>' data-order-id="<%= order['AmazonOrderId'] %>"><i class="fas fa-sync-alt"></i></button>
                  <% else %>
                    <button class="btn btn-primary change-order-status" data-order-status='<%= 'concluded' %>' data-order-id="<%= order['AmazonOrderId'] %>">Marcar</button>
                  <% end %>
                </div>
              </td>
              <td class="text-center">
                <b><%= horas_ou_dias_atras(order['PurchaseDate']) %></b>
                <p><%= formatar_data(order['PurchaseDate']) %></p>
              </td>
              <td class="text-center"><span class="text-primary"><b><%= order['AmazonOrderId'] %></b></span></td>
              <td class="text-center text-secondary"><i class="fas fa-image h2"></i></td>
              <td class="text-center loading-product" data-order-id='<%= order['AmazonOrderId'] %>' width=300><i class="fas fa-spinner fa-spin"></i></td>
              <td class="text-center">
                <span class="badge bg-danger">
                  <%= order['OrderStatus'] %> (<%= order['NumberOfItemsUnshipped'] %>)
                </span>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="14">
              
            </th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
<script>
  $(document).on('click', '.change-order-status', function() {
    var button = $(this);
    var orderId = button.data('order-id');
    var orderStatus = button.data('order-status');

    $.ajax({
      url: '<%= change_order_markup_status_dashboard_index_path %>',
      type: 'POST',
      data: {
        amazon_order_id: orderId,
        status: orderStatus
      },
      success: function(data) {
        if (orderStatus === 'pending') {
          button.removeClass('btn-success').removeClass('btn-light').addClass('btn-primary').html('Marcar').attr('data-order-status', 'concluded');
          button.parent('.btn-group').find('.btn-success').remove();
        } else {
          button.removeClass('btn-primary').addClass('btn-success').html('<i class="fas fa-check"></i>');
          var newButton = $('<button>').addClass('btn btn-light change-order-status').attr('data-order-status', 'pending').attr('data-order-id', orderId).html('<i class="fas fa-sync-alt"></i>');
          button.after(newButton);
        }
      },
      error: function(xhr, status, error) {

      }
    });
  });
</script>
<script>
$(document).ready(function() {
  var loadingProducts = $('.loading-product');

  function makeAjaxRequest(index) {
    if (index < loadingProducts.length) {
      var orderId = $(loadingProducts[index]).data('order-id');
      var loadingProductElement = $(loadingProducts[index]);

      $.ajax({
        url: "<%= search_specific_order_dashboard_index_path %>",
        method: "GET",
        data: {
          amazon_order_id: orderId
        },
        success: function(response) {
          console.log(response);
          loadingProductElement.html('');

          if (response.payload && response.payload.OrderItems) {
            var orderItems = response.payload.OrderItems;

            orderItems.forEach(function(item) {
              $.ajax({
                url: "<%= find_by_seller_sku_products_path %>",
                method: "GET",
                data: {
                  seller_sku: item.SellerSKU
                },
                success: function(productResponse) {
                  var productId = productResponse.id;

                  var editLink = '/products/' + productId + '/edit';
                  var html = '<span><p><b><button class="btn btn-light btn-sm text-dark" href="' + editLink + '"><i class="fas fa-edit"></i></button></b></p></span>';
                  html += '<span><p><b><button class="btn btn-light btn-sm text-dark" href="' + productResponse.supplier_url + '"><i class="fas fa-edit"></i></button></b></p></span>';
                  html += '<span><p style="font-size:9px !important;">' + item.Title + '</p></span>';
                  html += '<span><p><b>SellerSKU:</b> ' + item.SellerSKU + '</p></span>';
                  html += '<span><p><b>ASIN:</b> ' + item.ASIN + '</p></span>';

                  loadingProductElement.append(html);
                },
                error: function(xhr, status, error) {
                  console.error(xhr.responseText);
                }
              });
            });
          } else {
            makeAjaxRequest(index);
          }

          makeAjaxRequest(index + 1);
        },
        error: function(xhr, status, error) {
          console.error(xhr.responseText);
          makeAjaxRequest(index + 1);
        }
      });
    }
  }

  makeAjaxRequest(0);
});
</script>
<script>
  $('.table').DataTable({
    lengthMenu: [ [100, 500, 1000], [100, 500, 1000] ]
  });
</script>
